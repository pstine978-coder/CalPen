#!/usr/bin/env python3
"""
Script to automatically configure multiple pentesting MCP servers for PentestAgent
"""

import json
import os
import shutil
import subprocess
from pathlib import Path

def find_tool_path(tool_name):
    """Find tool executable path"""
    try:
        path = shutil.which(tool_name)
        if path and os.path.exists(path):
            return path
    except Exception:
        pass

    # Common locations for Kali Linux
    common_paths = [
        f"/usr/bin/{tool_name}",
        f"/usr/local/bin/{tool_name}",
        f"/opt/{tool_name}/{tool_name}",
        f"/usr/sbin/{tool_name}",
        f"/snap/bin/{tool_name}",
    ]

    for path in common_paths:
        if os.path.exists(path):
            return path

    return None

def check_metasploit():
    """Check if Metasploit is available"""
    try:
        # Check for msfconsole
        msf_path = find_tool_path("msfconsole")
        if msf_path:
            return msf_path

        # Check for msfrpcd
        rpc_path = find_tool_path("msfrpcd")
        if rpc_path:
            return rpc_path
    except Exception:
        pass
    return None

def get_pentesting_tools_config():
    """Get configurations for common pentesting tools"""
    tools_config = []

    # Nmap Scanner (already configured, but let's include it)
    nmap_path = find_tool_path("nmap")
    if nmap_path:
        tools_config.append({
            "name": "Nmap Scanner",
            "params": {
                "command": "npx",
                "args": ["-y", "gc-nmap-mcp"],
                "env": {"NMAP_PATH": nmap_path}
            },
            "cache_tools_list": True
        })

    # Hydra
    hydra_path = find_tool_path("hydra")
    if hydra_path:
        tools_config.append({
            "name": "Hydra",
            "params": {
                "command": "npx",
                "args": ["-y", "gc-hydra-mcp"],
                "env": {"HYDRA_PATH": hydra_path}
            },
            "cache_tools_list": True
        })

    # SQLMap
    sqlmap_path = find_tool_path("sqlmap")
    if sqlmap_path:
        tools_config.append({
            "name": "SQLMap",
            "params": {
                "command": "npx",
                "args": ["-y", "gc-sqlmap-mcp"],
                "env": {"SQLMAP_PATH": sqlmap_path}
            },
            "cache_tools_list": True
        })

    # Nuclei
    nuclei_path = find_tool_path("nuclei")
    if nuclei_path:
        tools_config.append({
            "name": "Nuclei Scanner",
            "params": {
                "command": "npx",
                "args": ["-y", "gc-nuclei-mcp"],
                "env": {"NUCLEI_PATH": nuclei_path}
            },
            "cache_tools_list": True
        })

    # FFUF
    ffuf_path = find_tool_path("ffuf")
    if ffuf_path:
        tools_config.append({
            "name": "FFUF Fuzzer",
            "params": {
                "command": "npx",
                "args": ["-y", "gc-ffuf-mcp"],
                "env": {"FFUF_PATH": ffuf_path}
            },
            "cache_tools_list": True
        })

    # Masscan
    masscan_path = find_tool_path("masscan")
    if masscan_path:
        tools_config.append({
            "name": "Masscan",
            "params": {
                "command": "npx",
                "args": ["-y", "gc-masscan-mcp"],
                "env": {"MASSCAN_PATH": masscan_path}
            },
            "cache_tools_list": True
        })

    # John the Ripper
    john_path = find_tool_path("john")
    if john_path:
        tools_config.append({
            "name": "John the Ripper",
            "params": {
                "command": "npx",
                "args": ["-y", "gc-john-mcp"],
                "env": {"JOHN_PATH": john_path}
            },
            "cache_tools_list": True
        })

    # Hashcat (check for hashcat or hashcat.bin)
    hashcat_path = find_tool_path("hashcat") or find_tool_path("hashcat.bin")
    if hashcat_path:
        tools_config.append({
            "name": "Hashcat",
            "params": {
                "command": "npx",
                "args": ["-y", "gc-hashcat-mcp"],
                "env": {"HASHCAT_PATH": hashcat_path}
            },
            "cache_tools_list": True
        })

    return tools_config

def main():
    print("=" * 70)
    print("Setting up Multiple Pentesting Tools MCP Servers for PentestAgent")
    print("=" * 70)

    # Load existing mcp.json
    mcp_config_file = "mcp.json"
    if os.path.exists(mcp_config_file):
        try:
            with open(mcp_config_file, 'r') as f:
                mcp_config = json.load(f)
            print("‚úÖ Loaded existing mcp.json configuration")
        except Exception as e:
            print(f"‚ùå Error loading mcp.json: {e}")
            mcp_config = {"servers": []}
    else:
        mcp_config = {"servers": []}
        print("üìÑ Created new mcp.json configuration")

    existing_servers = mcp_config.get("servers", [])
    existing_names = [server.get("name") for server in existing_servers]

    # Get available pentesting tools
    new_tools = get_pentesting_tools_config()

    added_count = 0
    updated_count = 0

    for tool_config in new_tools:
        tool_name = tool_config["name"]

        if tool_name in existing_names:
            # Update existing
            idx = existing_names.index(tool_name)
            existing_servers[idx] = tool_config
            print(f"üîÑ Updated existing: {tool_name}")
            updated_count += 1
        else:
            # Add new
            existing_servers.append(tool_config)
            print(f"‚ûï Added new tool: {tool_name}")
            added_count += 1

    # Save configuration
    mcp_config["servers"] = existing_servers

    try:
        with open(mcp_config_file, 'w') as f:
            json.dump(mcp_config, f, indent=2)
        print("\n‚úÖ Successfully saved mcp.json configuration")
        print("üìä Configuration Summary:")
        print(f"   ‚Ä¢ Added: {added_count} new tools")
        print(f"   ‚Ä¢ Updated: {updated_count} existing tools")
        print(f"   ‚Ä¢ Total tools configured: {len(existing_servers)}")
        return True
    except Exception as e:
        print(f"‚ùå Error saving mcp.json: {e}")
        return False

if __name__ == "__main__":
    success = main()
    if success:
        print("\nüéâ Pentesting tools MCP setup complete!")
        print("\nAvailable tools include:")
        print("‚Ä¢ Nmap Scanner")
        print("‚Ä¢ Hydra (password cracking)")
        print("‚Ä¢ SQLMap (SQL injection)")
        print("‚Ä¢ Nuclei (vulnerability scanner)")
        print("‚Ä¢ FFUF (web fuzzer)")
        print("‚Ä¢ Masscan (fast port scanner)")
        print("‚Ä¢ John the Ripper (password cracker)")
        print("‚Ä¢ Hashcat (GPU password cracker)")
        print("\nNote: Metasploit MCP package not available yet")
        print("\nTo use these tools:")
        print("  python main.py")
        print("  Select 'Configure or connect MCP tools' when prompted")
        print("  Choose the tools you want to use")
    else:
        print("\n‚ùå Setup failed!")
        exit(1)
